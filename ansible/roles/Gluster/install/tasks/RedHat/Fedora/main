---

- name: Install glusterfs-server
  ansible.builtin.dnf:
    name:
      - glusterfs-server
    state: latest
  become: true

- name: Enable & Start GlusterFS management daemon
  ansible.builtin.systemd:
    name: glusterd
    enabled: yes
    state: started
  become: true


- name: Get other Node IPs
  set_fact:
    other_nodes: "{{ groups['nodes'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | difference( ansible_default_ipv4.address ) }}"


- name: Step 4 - Configure the firewall
  become: true
  ansible.builtin.iptables:
    chain: INPUT
    source: "{{item}}"
    protocol: all
    jump: ACCEPT
    # comment: accept all traffic from the other node
  loop: "{{ other_nodes }}"

# Fixes:
- name: Firewalld allow gluster
  become: true
  ansible.posix.firewalld:
    service: glusterfs
    permanent: yes
    state: enabled
# https://serverfault.com/questions/919112/peer-probe-failed-probe-returned-with-transport-endpoint-is-not-connacted
