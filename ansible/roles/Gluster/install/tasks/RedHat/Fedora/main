---

- name: Install glusterfs-server
  ansible.builtin.dnf:
    name:
      - glusterfs-server
    state: latest
  become: true

- name: Enable & Start GlusterFS management daemon
  ansible.builtin.systemd:
    name: glusterd
    enabled: yes
    state: started
  become: true


- name: Get other Node IPs
  set_fact:
    other_nodes: "{{ groups['nodes'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | difference( ansible_default_ipv4.address ) }}"


- name: Make firewall Idempotent - workaround
  stat:
    path: /etc/glusterfs/firewall-set
  register: firewall_set


- name: Step 4 - Configure the firewall
  become: true
  ansible.builtin.iptables:
    chain: INPUT
    source: "{{item}}"
    protocol: all
    jump: ACCEPT
    comment: accept all traffic from gluster nodes
  loop: "{{ other_nodes }}"
  notify:
    - flush iptables INPUT
  when: not firewall_set.stat.exists is defined

# Fixes:
- name: Firewalld allow gluster
  become: true
  ansible.posix.firewalld:
    service: glusterfs
    permanent: yes
    state: enabled
  notify:
    - restart firewalld
    - make firewall idempotent
  when: not firewall_set.stat.exists is defined

# https://serverfault.com/questions/919112/peer-probe-failed-probe-returned-with-transport-endpoint-is-not-connacted
